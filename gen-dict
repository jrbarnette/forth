#!/bin/bash
# Copyright 2019, by J. Richard Barnette. All Rights Reserved.

cd $(dirname $0)

usage() {
    echo "usage: $(basename $0) target-type" >&2
    exit 1
}

list() {
    for f in "$@"
    do
        echo $f
    done
}

gen() {
    cat <<END_HEAD
/*
 * Copyright 2019, by J. Richard Barnette. All Rights Reserved.
 */

/* This file was automatically generated by "${GENCMD}" */

END_HEAD
    cat "$@" | bootstrap/forth
}

build() {
    gen "$@" >$FILE
    cd bootstrap
    make
}

changes() {
    gen "$@" | diff - $FILE
}

dry_run() {
    gen "$@" >/dev/null
}

regen() {
    cd bootstrap
    git checkout initdict.c
    make
    cd ..
    gen "$@" >$FILE
}

MODE=gen
FILE=bootstrap/initdict.c
while getopts gbtlnsrf: opt
do
    case $opt in
        g) MODE=gen ;;
        b) MODE=build ;;
        t) MODE=changes ;;
        l) MODE=list ;;
        n) MODE=dry_run ;;
        s) MODE=cat ;;
        r) MODE=regen ;;
        f) FILE=$OPTARG ;;
        \?) usage ;;
    esac
done
shift $(( OPTIND - 1 ))
GENCMD="$(basename $0) $*"

if [ $# -ne 1 ]
then
    usage
fi

FILEORDER="forth/$1/file-order"
if [ ! -f $FILEORDER ]
then
    echo "$FILEORDER: no file" >&2
    usage
fi

$MODE $(sed 's/#.*//' $FILEORDER)
